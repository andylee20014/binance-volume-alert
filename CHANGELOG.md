# 变更日志

## [修复] 2025-07-22 - K线数据获取逻辑修复

### 问题描述
- 原代码在每个5分钟周期的第3秒获取数据
- 使用 `klines[6]`（正在进行中的K线）作为当前交易量
- 导致当前交易量只包含3秒的数据，严重偏小
- 影响交易量倍数计算的准确性

### 修复内容
- **K线获取数量**: 从获取7根K线改为获取8根K线
- **当前数据选择**: 
  - **修改前**: 在7根K线中使用 `klines[6]`（最新一根，正在进行中，只有3秒数据）
  - **修改后**: 在8根K线中使用 `klines[6]`（倒数第二根，已完成，完整5分钟数据）
- **历史基准**: 保持使用前6根完整K线（30分钟）的平均交易量
- **计算逻辑**: 最新完整5分钟交易量 vs 前30分钟平均交易量

### 影响
- ✅ 交易量倍数计算更加准确
- ✅ 减少误报和漏报
- ✅ 提高预警系统的可靠性
- ✅ 保持30分钟历史基准，逻辑更加合理

### 技术细节
```javascript
// 修改前（获取7根K线）
limit: 7
// klines[0-5]: 历史完整K线, klines[6]: 正在进行中的K线（3秒数据）
const currentKline = klines[6];      // 正在进行中（3秒数据）
const historicalKlines = klines.slice(0, 6);  // 前6根K线
const avgVolume = sum / 6;           // 30分钟平均

// 修改后（获取8根K线）
limit: 8
// klines[0-5]: 历史K线, klines[6]: 最新完整K线, klines[7]: 正在进行中的K线
const currentKline = klines[6];      // 最新完整K线（完整5分钟数据）
const historicalKlines = klines.slice(0, 6);  // 前6根K线
const avgVolume = sum / 6;           // 30分钟平均
```

### 实际效果示例
假设当前时间是 10:05:03（5分钟周期刚开始第3秒）：

**修改前（7根K线）**：
- 获取: 09:35-09:40, 09:40-09:45, ..., 09:55-10:00, 10:00-10:05
- 当前数据: 10:00-10:05 K线（只有3秒数据） ❌
- 历史基准: 09:35-10:00 (30分钟完整数据) ✅

**修改后（8根K线）**：
- 获取: 09:25-09:30, 09:30-09:35, ..., 09:55-10:00, 10:00-10:05
- 当前数据: 09:55-10:00 K线（完整5分钟数据） ✅
- 历史基准: 09:25-09:55 (30分钟完整数据) ✅ 